ТЗ: Надёжное управление администратором (Flask + SQLAlchemy)
Цель

Обеспечить гарантированное и предсказуемое создание/восстановление администратора после любого обновления, включая:

git pull

пересоздание БД

загрузку дампа из админки

сброс пароля

отсутствие .env или изменение переменных окружения

Администратор не должен теряться, не должен создаваться дублирующе, пароль должен быть управляем.

Проблемы, которые надо устранить

Администратор сейчас создаётся:

неявно

частично закомментирован

зависит от порядка вызовов (db.create_all, flask db upgrade)

При загрузке дампа БД:

пользователь admin может перезаписываться

пароль становится неизвестным

Логика создания администратора:

размазана по app.py

не предназначена для повторного безопасного запуска

Требуемое архитектурное решение (обязательно)
1. Убрать создание администратора из create_app()

❌ НЕЛЬЗЯ:

db.create_all()
init_default_data()


внутри create_app()

Причина:
create_app() должен быть чистым, без побочных эффектов.

2. Ввести отдельную CLI-команду Flask

Создать файл, например:

cli/admin.py


С командой:

flask admin ensure

3. Поведение команды flask admin ensure
Алгоритм (строго):

Подключиться к БД

Найти пользователя с:

username == ADMIN_USERNAME


Если НЕ найден:

создать пользователя

установить пароль из ADMIN_PASSWORD

role = 'admin'

is_active = True

Если найден:

НИЧЕГО не менять по умолчанию

Если передан флаг --reset-password:

принудительно обновить пароль

4. Интерфейс команды
flask admin ensure

flask admin ensure --reset-password

5. Источник логина и пароля

❗ Только переменные окружения

ADMIN_USERNAME=admin
ADMIN_PASSWORD=strong_password_here


❌ Никаких хардкодов
❌ Никаких дефолтов типа admin / admin123

Если переменных нет — команда должна:

завершиться с ошибкой

вывести понятное сообщение в лог

6. Логирование (обязательно)

Примеры сообщений:

Admin user created: admin

Admin user exists: admin (no changes)

Admin password reset for user: admin

7. Регламент использования (должен быть задокументирован)
После чистой БД:
flask db upgrade
flask admin ensure

После загрузки дампа:
flask admin ensure --reset-password

После git pull:
pip install -r requirements.txt
flask db upgrade
flask admin ensure
sudo systemctl restart gtt2026

8. Что НЕ делать

❌ Не создавать администратора автоматически при старте сервера

❌ Не завязывать логику на Alembic

❌ Не менять пароль молча

❌ Не плодить пользователей admin, admin2, superadmin

Критерий приёмки

Можно в любой момент восстановить доступ в админку одной командой

Команда идемпотентна (можно запускать сколько угодно раз)

Поведение одинаково:

на локали

на сервере

после дампа

после пересоздания БД

Дополнение (желательно, но не обязательно)

Добавить flask admin info (показывает, существует ли админ, без паролей)