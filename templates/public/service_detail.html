{% extends 'base.html' %}

{% block hero %}
<h1 class="visually-hidden">{{ service.h1 or service.title }}</h1>
{% set hero_img = service.hero_image or service.get_main_image() or '/static/images/WhatsApp_Image_2019-10-21_at_13.44.44_1766758697538.jpeg' %}
<section class="hero page-hero" style="background-image: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('{{ hero_img }}');">
    <div class="container">
        <div class="hero-content">
            <div class="hero-main-title">{{ service.hero_title or service.title }}</div>
            {% if service.hero_subtitle %}
            <p class="hero-desc">{{ service.hero_subtitle }}</p>
            {% endif %}
        </div>
    </div>
</section>
{% endblock %}

{% block content %}
<nav class="breadcrumbs">
    {% for crumb in breadcrumbs %}
    {% if crumb.url %}
    <a href="{{ crumb.url }}">{{ crumb.name }}</a> /
    {% else %}
    <span>{{ crumb.name }}</span>
    {% endif %}
    {% endfor %}
</nav>

<div class="service-detail">
    <div class="content-text">
        {{ service.content_html|safe }}
    </div>
    
    {% set images = service.images.order_by('sort_order').all() %}
    {% if images|length > 0 %}
    <div class="service-gallery" data-interval="{{ (service.gallery_interval or 5) * 1000 }}" data-count="{{ images|length }}">
        <div class="gallery-wrapper">
            {% if images|length > 3 %}
            <button class="gallery-nav gallery-prev" aria-label="Назад">&lsaquo;</button>
            {% endif %}
            <div class="gallery-track">
                {% for img in images %}
                <div class="gallery-slide">
                    <img src="{{ watermark_url('service', img.id) }}" alt="{{ img.alt_text or service.title }}" loading="lazy" style="{% if img.rotation %}transform: rotate({{ img.rotation }}deg);{% endif %}">
                </div>
                {% endfor %}
            </div>
            {% if images|length > 3 %}
            <button class="gallery-nav gallery-next" aria-label="Вперёд">&rsaquo;</button>
            {% endif %}
        </div>
        {% if images|length > 3 %}
        <div class="gallery-dots">
            {% for i in range((images|length - 2)|abs) %}
            <button class="gallery-dot {% if loop.first %}active{% endif %}" data-index="{{ i }}" aria-label="Слайд {{ loop.index }}"></button>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% elif service.image_path %}
    <div class="service-single-image">
        <img src="{{ service.image_path }}" alt="{{ service.title }}">
    </div>
    {% endif %}
    
    <section class="service-cta-section" id="callback">
        <div class="cta-content">
            <div class="cta-info">
                <h3>Заинтересовала услуга?</h3>
                <p>Оставьте заявку, и наш специалист свяжется с вами для консультации.</p>
            </div>
        </div>
        <div class="cta-form-wrapper">
            <form action="{{ url_for('public.submit_lead') }}" method="POST" class="lead-form service-lead-form" id="service-lead-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="message" value="Заявка на услугу: {{ service.title }}">
                <input type="hidden" name="page_url" value="{{ request.url }}">
                <input type="hidden" name="utm_source" value="">
                <input type="hidden" name="utm_medium" value="">
                <input type="hidden" name="utm_campaign" value="">
                <input type="hidden" name="utm_term" value="">
                <input type="hidden" name="utm_content" value="">
                <input type="hidden" name="captcha_token" id="service-captcha-token" value="">
                <div style="display:none !important;"><input type="text" name="website" tabindex="-1" autocomplete="off"></div>
                <div class="form-row">
                    <input type="text" name="name" placeholder="Ваше имя" required>
                </div>
                <div class="form-row">
                    <input type="tel" name="phone" placeholder="Телефон" required>
                </div>
                <div class="form-row">
                    <input type="email" name="email" placeholder="Email">
                </div>
                <div class="form-row captcha-row">
                    <label id="service-captcha-question">Загрузка...</label>
                    <input type="number" name="captcha_answer" placeholder="Ответ" required>
                </div>
                <button type="submit" class="btn btn-primary">Отправить заявку</button>
            </form>
        </div>
    </section>
    
    {% if service.seo_text_html %}
    <div class="seo-text">
        {{ service.seo_text_html|safe }}
    </div>
    {% endif %}
</div>

<style>
.service-detail { max-width: 1000px; margin: 0 auto; }
.content-text { 
    font-size: 16px; 
    line-height: 1.8; 
    color: var(--text-color);
    margin-bottom: 40px;
}
.content-text p { margin-bottom: 16px; }
.content-text h2 { margin: 24px 0 16px; }
.content-text h3 { margin: 20px 0 12px; }

.service-gallery {
    margin: 40px 0;
    position: relative;
}
.gallery-wrapper {
    position: relative;
    overflow: hidden;
    border-radius: var(--radius-lg);
    background: #f8f9fa;
}
.gallery-track {
    display: flex;
    transition: transform 0.5s ease;
}
.gallery-slide {
    flex: 0 0 calc(100% / 3);
    padding: 10px;
    box-sizing: border-box;
}
.gallery-slide img {
    width: 100%;
    height: 220px;
    object-fit: cover;
    border-radius: var(--radius);
    cursor: pointer;
    transition: transform 0.3s;
}
.gallery-slide img:hover {
    transform: scale(1.03);
}
.gallery-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 44px;
    height: 44px;
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    z-index: 10;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    justify-content: center;
}
.gallery-nav:hover { background: white; }
.gallery-prev { left: 10px; }
.gallery-next { right: 10px; }
.gallery-dots {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 15px;
}
.gallery-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: none;
    background: #ddd;
    cursor: pointer;
    transition: background 0.3s;
}
.gallery-dot.active { background: var(--primary-color); }

.service-action {
    text-align: center;
    margin: 60px 0;
    padding: 40px;
    background: var(--bg-light);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
}
.service-action h3 { margin-bottom: 20px; }
.service-action p { margin-bottom: 30px; color: var(--text-light); }

.seo-text {
    margin-top: 60px;
    padding-top: 40px;
    border-top: 2px solid var(--border-color);
}

.service-single-image {
    margin: 40px 0;
    text-align: center;
    background: white;
    padding: 30px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
}
.service-single-image img {
    max-width: 100%;
    max-height: 400px;
    object-fit: contain;
}

@media (max-width: 768px) {
    .gallery-slide { flex: 0 0 100%; }
    .gallery-nav { width: 36px; height: 36px; font-size: 20px; }
}
</style>

<script>
(function() {
    const gallery = document.querySelector('.service-gallery');
    if (!gallery) return;
    
    const track = gallery.querySelector('.gallery-track');
    const slides = gallery.querySelectorAll('.gallery-slide');
    const dots = gallery.querySelectorAll('.gallery-dot');
    const prevBtn = gallery.querySelector('.gallery-prev');
    const nextBtn = gallery.querySelector('.gallery-next');
    const interval = parseInt(gallery.dataset.interval) || 5000;
    const totalSlides = parseInt(gallery.dataset.count) || slides.length;
    
    let currentIndex = 0;
    let autoSlideTimer;
    
    function getSlidesPerView() {
        return window.innerWidth > 768 ? Math.min(3, totalSlides) : 1;
    }
    
    function getMaxIndex() {
        const spv = getSlidesPerView();
        return Math.max(0, totalSlides - spv);
    }
    
    function updateSlider() {
        const spv = getSlidesPerView();
        const slideWidth = 100 / spv;
        track.style.transform = `translateX(-${currentIndex * slideWidth}%)`;
        
        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === currentIndex);
        });
    }
    
    function slide(direction) {
        const maxIdx = getMaxIndex();
        currentIndex += direction;
        if (currentIndex < 0) currentIndex = maxIdx;
        if (currentIndex > maxIdx) currentIndex = 0;
        updateSlider();
        resetAutoSlide();
    }
    
    function goToSlide(index) {
        currentIndex = Math.min(index, getMaxIndex());
        updateSlider();
        resetAutoSlide();
    }
    
    function autoSlide() {
        const maxIdx = getMaxIndex();
        if (maxIdx <= 0) return;
        currentIndex++;
        if (currentIndex > maxIdx) currentIndex = 0;
        updateSlider();
    }
    
    function resetAutoSlide() {
        clearInterval(autoSlideTimer);
        if (getMaxIndex() > 0) {
            autoSlideTimer = setInterval(autoSlide, interval);
        }
    }
    
    if (prevBtn) prevBtn.addEventListener('click', () => slide(-1));
    if (nextBtn) nextBtn.addEventListener('click', () => slide(1));
    
    dots.forEach((dot, i) => {
        dot.addEventListener('click', () => goToSlide(i));
    });
    
    window.addEventListener('resize', function() {
        if (currentIndex > getMaxIndex()) currentIndex = getMaxIndex();
        updateSlider();
    });
    
    updateSlider();
    resetAutoSlide();
})();
</script>
{% endblock %}
