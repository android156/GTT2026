# ГлавТрубТорг - Flask Website

Корпоративный сайт компании ГлавТрубТорг на Flask с 4-уровневым каталогом продукции, админкой с полным CRUD, SEO-оптимизацией и Telegram-ботом.

## Запуск

```bash
python app.py
```

Сайт будет доступен по адресу: http://localhost:5000

## Основные возможности

### Каталог продукции (4 уровня)
- **Каталог** → **Категория** → **Линейка** → **Типоразмер**
- Гибкая настройка SEO для каждого уровня
- Галереи изображений с автопрокруткой
- Блоки комплектующих для линеек
- Таблица типоразмеров с ценами и наличием

### Услуги
- Отдельный раздел с услугами компании
- Галереи изображений для каждой услуги
- WYSIWYG редактор контента
- Hero-баннеры с настраиваемыми заголовками

### Новости
- Публикация новостей с датой
- SEO-оптимизация каждой новости
- Вывод на главной странице

### Статические страницы
- О компании, Контакты, Цены, Документация
- Hero-баннеры с изображениями
- Яндекс.Карта на странице контактов

## Админка

- **URL:** /admin/
- **Логин по умолчанию:** admin / admin123

### Структура меню админки

**Контент:**
- Страницы (статические)
- Меню навигации
- Новости
- Разделы сайта (главная, каталог, услуги, новости)

**Каталог:**
- Категории
- Линейки продукции
- Типоразмеры

**Услуги:**
- Список услуг

**Заявки:**
- Входящие заявки (Leads)

**Настройки:**
- Общие настройки (контакты, Telegram)
- Редиректы
- Документы
- Водяной знак

## Галереи изображений

#### Возможности
- Загрузка нескольких изображений
- Drag-and-drop сортировка
- Автопрокрутка с настраиваемым интервалом (сек)
- Ручная навигация (стрелки, точки)
- Поворот изображений на 90° влево/вправо
- **Водяные знаки:** автоматическое наложение на изображения галерей (настраиваемая прозрачность)

### Формы и уведомления

#### Каналы доставки
1. **Email:** Яндекс SMTP (sale@glavtrubtorg.ru) — основной архивный канал.
2. **Telegram:** Уведомления в групповой чат через бота (настройка TOKEN и CHAT_ID в админке).
3. **amoCRM:** (В процессе) Интеграция через OAuth 2.0 для создания сделок и контактов.

#### Защита и UTM
- **Капча:** Математическая защита (сложение/вычитание) для всех форм.
- **Honeypot:** Скрытое поле для защиты от спам-ботов.
- **UTM-метки:** Сбор и передача меток (source, medium, campaign, term, content) во всех уведомлениях.

### SEO-редактирование изображений
- Редактирование alt, title, caption
- Оптимизация (сжатие, ресайз до 1920px)
- Конвертация в WebP
- Переименование файлов
- Просмотр информации (размеры, вес, формат)

## Hero-баннеры

Настраиваемые баннеры для:
- Страниц (about, contacts, price, documentation)
- Категорий каталога
- Линеек продукции
- Услуг
- Разделов сайта (главная, каталог, услуги, новости)

Параметры:
- Фоновое изображение
- Заголовок
- Подзаголовок

## URL-структура

### Публичные страницы
| URL | Описание |
|-----|----------|
| `/` | Главная страница |
| `/about/` | О компании |
| `/services/` | Список услуг |
| `/services/<slug>/` | Страница услуги |
| `/price/` | Цены |
| `/documentation/` | Документация |
| `/contacts/` | Контакты (с Яндекс.Картой) |
| `/news/` | Список новостей |
| `/news/<slug>/` | Страница новости |
| `/catalog/` | Каталог (все категории) |

### Каталог (4 уровня)
| URL | Уровень |
|-----|---------|
| `/<category>/` | Категория |
| `/<category>/<product>/` | Линейка продукции |
| `/<category>/<product>/<size>/` | Типоразмер |

### Системные
| URL | Описание |
|-----|----------|
| `/sitemap.xml` | Карта сайта |
| `/robots.txt` | Правила для роботов |
| `/wm/<type>/<id>/` | Изображения с водяным знаком |

## Редиректы

### Системные (автоматические)
- `/catalog/xxx/` → `/xxx/` (301)
- `/xxx` → `/xxx/` (добавление слеша, 301)

### Ручные
- Настраиваются в админке: /admin/redirects/
- Приоритет над системными редиректами
- Поддержка кодов 301 и 302

## Импорт/Экспорт CSV

### Импорт
Разделитель: точка с запятой (;)

**categories.csv:**
```
name;slug;description_html;image_path;seo_title;seo_description;h1;seo_text_html;sort_order;is_active
```

**product_lines.csv:**
```
category_slug;name;slug;description_html;image_path;seo_title;seo_description;h1;seo_text_html;sort_order;is_active
```

**size_items.csv:**
```
category_slug;product_slug;size_text;size_slug;sku;price;currency;unit;in_stock;image_path
```

**news.csv:**
```
date;title;slug;content_html;seo_title;seo_description;h1;seo_text_html
```

### Экспорт
Кнопка "Скачать CSV" доступна в списках:
- Категории
- Линейки
- Типоразмеры
- Новости

## SEO

### Мета-теги
- title (автогенерация или ручной)
- description (автогенерация или ручной)
- canonical URL
- OpenGraph теги (og:title, og:description, og:image, og:url)

### Микроразметка JSON-LD
- Product (для линеек и типоразмеров)
- BreadcrumbList (хлебные крошки)
- Organization (организация)

### Карта сайта
- Автоматическая генерация sitemap.xml
- Все публичные страницы, категории, линейки, типоразмеры, новости, услуги

## Telegram бот

### Настройка
В админке (Настройки) или переменных окружения:
- `TELEGRAM_TOKEN` — токен от @BotFather
- `TELEGRAM_CHAT_ID` — ID чата для уведомлений

### Запуск
```bash
python telegram_bot.py
```

### Функции
- Уведомления о новых заявках
- Базовые команды бота

## Структура проекта

```
├── app.py                  # Точка входа, фабрика приложения
├── config.py               # Конфигурация
├── extensions.py           # Flask расширения (db, migrate, login)
├── models.py               # Модели БД (SQLAlchemy)
├── blueprints/
│   ├── public.py           # Публичные маршруты
│   ├── admin.py            # Админка (CRUD)
│   └── redirects.py        # Обработка редиректов
├── services/
│   ├── seo.py              # SEO-функции
│   ├── schema.py           # JSON-LD микроразметка
│   ├── slug.py             # Генерация слагов
│   ├── importers.py        # CSV импорт
│   ├── telegram_service.py # Уведомления в Telegram
│   └── image_utils.py      # Работа с изображениями, водяные знаки
├── templates/
│   ├── base.html           # Базовый шаблон
│   ├── public/             # Публичные страницы
│   └── admin/              # Шаблоны админки
├── static/
│   ├── css/                # Стили
│   ├── uploads/            # Загруженные файлы
│   └── images/             # Статичные изображения
├── migrations/             # Миграции БД (Flask-Migrate)
└── telegram_bot.py         # Telegram бот
```

## Модели базы данных

| Модель | Описание |
|--------|----------|
| User | Пользователи админки |
| Page | Статические страницы |
| MenuItem | Пункты меню навигации |
| Category | Категории каталога |
| ProductLine | Линейки продукции |
| ProductLineImage | Изображения галереи линейки |
| SizeItem | Типоразмеры |
| Service | Услуги |
| ServiceImage | Изображения галереи услуги |
| News | Новости |
| SiteSection | Разделы сайта (главная, каталог и т.д.) |
| HomeGalleryImage | Изображения галереи главной |
| AccessoryBlock | Блоки комплектующих |
| Lead | Входящие заявки |
| RedirectRule | Правила редиректов |
| Setting | Общие настройки |
| DocumentFile | Загруженные документы |

## Переменные окружения

```env
# Обязательные
SECRET_KEY=your-secret-key
DATABASE_URL=postgresql://user:pass@host:port/dbname

# Админка
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your-secure-password

# Telegram (опционально)
TELEGRAM_TOKEN=your-bot-token
TELEGRAM_CHAT_ID=your-chat-id

# Сайт
SITE_URL=https://glavtrubtorg.ru
```

## Миграции БД

```bash
flask db init      # Инициализация (один раз)
flask db migrate   # Создание миграции после изменений моделей
flask db upgrade   # Применение миграций
```

## Технологии

- **Backend:** Python 3.11, Flask, Flask-SQLAlchemy, Flask-Login, Flask-WTF, Flask-Migrate
- **Database:** PostgreSQL
- **Frontend:** Jinja2, CSS (без фреймворков)
- **Изображения:** Pillow (оптимизация, водяные знаки)
- **Telegram:** python-telegram-bot
- **HTTP:** requests

## Лицензия

Проприетарное ПО. Все права защищены.
