{% macro wysiwyg_editor(field_id, field_name, content, rows=10) %}
<div class="ckeditor-wrapper">
    <div id="{{ field_id }}_editor" class="ckeditor-container"></div>
    <textarea name="{{ field_name }}" id="{{ field_id }}" class="ckeditor-hidden" style="display: none;">{{ content }}</textarea>
</div>
{% endmacro %}

{% macro wysiwyg_styles() %}
<style>
.ckeditor-wrapper {
    margin-bottom: 15px;
}
.ckeditor-container {
    border: 1px solid #ccc;
    border-radius: 4px;
    min-height: 200px;
}
.ckeditor-container .ck-editor__editable {
    min-height: 200px;
}
.ckeditor-container .ck-editor__editable_inline {
    padding: 15px;
}
.ck.ck-editor__main>.ck-editor__editable {
    background: white;
}
.ck.ck-editor__editable:not(.ck-editor__nested-editable).ck-focused {
    border-color: #d32f2f;
    box-shadow: none;
}
.ck-content h2 { font-size: 1.5em; margin: 0.8em 0 0.4em; }
.ck-content h3 { font-size: 1.25em; margin: 0.7em 0 0.35em; }
.ck-content p { margin: 0.5em 0; line-height: 1.6; }
.ck-content ul, .ck-content ol { margin: 0.5em 0; padding-left: 1.5em; }
.ck-content li { margin: 0.25em 0; }
.ck-content table { border-collapse: collapse; width: 100%; margin: 1em 0; }
.ck-content table td, .ck-content table th { border: 1px solid #ccc; padding: 8px; }
.ck-content table th { background: #f5f5f5; font-weight: bold; }
.ck-content a { color: #d32f2f; text-decoration: underline; }
</style>
{% endmacro %}

{% macro wysiwyg_scripts() %}
<script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const editorContainers = document.querySelectorAll('.ckeditor-container');
    
    editorContainers.forEach(function(container) {
        const editorId = container.id.replace('_editor', '');
        const textarea = document.getElementById(editorId);
        
        if (!textarea) return;
        
        ClassicEditor
            .create(container, {
                language: 'ru',
                toolbar: {
                    items: [
                        'heading', '|',
                        'bold', 'italic', 'underline', 'strikethrough', '|',
                        'link', '|',
                        'bulletedList', 'numberedList', '|',
                        'alignment', '|',
                        'insertTable', '|',
                        'undo', 'redo', '|',
                        'sourceEditing'
                    ]
                },
                heading: {
                    options: [
                        { model: 'paragraph', title: 'Параграф', class: 'ck-heading_paragraph' },
                        { model: 'heading2', view: 'h2', title: 'Заголовок 2', class: 'ck-heading_heading2' },
                        { model: 'heading3', view: 'h3', title: 'Заголовок 3', class: 'ck-heading_heading3' },
                        { model: 'heading4', view: 'h4', title: 'Заголовок 4', class: 'ck-heading_heading4' }
                    ]
                },
                table: {
                    contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells']
                },
                link: {
                    decorators: {
                        openInNewTab: {
                            mode: 'manual',
                            label: 'Открывать в новой вкладке',
                            attributes: {
                                target: '_blank',
                                rel: 'noopener noreferrer'
                            }
                        }
                    }
                },
                initialData: textarea.value
            })
            .then(editor => {
                container.editorInstance = editor;
                
                editor.model.document.on('change:data', () => {
                    textarea.value = editor.getData();
                });
                
                const form = textarea.closest('form');
                if (form) {
                    form.addEventListener('submit', () => {
                        textarea.value = editor.getData();
                    });
                }
            })
            .catch(error => {
                console.error('CKEditor initialization error:', error);
                container.innerHTML = '<textarea name="' + textarea.name + '" id="' + editorId + '" rows="10" style="width: 100%;">' + textarea.value + '</textarea>';
            });
    });
});
</script>
{% endmacro %}

{% macro wysiwyg_toolbar(field_id) %}
{% endmacro %}
