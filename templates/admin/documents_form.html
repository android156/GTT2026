{% extends 'admin/base.html' %}
{% import 'admin/_wysiwyg.html' as wysiwyg %}
{% block title %}{% if doc %}Редактировать документ{% else %}Загрузить документ{% endif %}{% endblock %}
{% block page_title %}{% if doc %}Редактировать документ{% else %}Загрузить документ{% endif %}{% endblock %}

{% block styles %}
{{ wysiwyg.wysiwyg_styles() }}
<style>
.document-tools { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; }
.document-tools h4 { margin: 0 0 15px 0; font-size: 16px; color: #333; }
.tool-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #ddd; }
.tool-section:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
.tool-row { display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; }
.tool-row .form-group { margin-bottom: 0; flex: 1; min-width: 200px; }
.preview-edit-section { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
.preview-image-container { flex: 0 0 200px; }
.preview-image-container img { max-width: 100%; border: 1px solid #ddd; border-radius: 4px; }
.preview-seo-fields { flex: 1; min-width: 250px; }
.optimize-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
.optimize-row .form-group { flex: 1; min-width: 100px; margin-bottom: 0; }
.info-badge { display: inline-block; background: #e9ecef; padding: 3px 8px; border-radius: 3px; font-size: 12px; color: #666; margin-right: 5px; }
.pdf-metadata-section { margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border: 1px solid #ffc107; }
.pdf-metadata-section h4 { margin: 0 0 15px 0; color: #856404; }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <div class="form-group">
            <label>Название *</label>
            <input type="text" name="title" value="{{ doc.title if doc else '' }}" required>
        </div>
        
        <div class="form-group">
            <label>Slug (URL)</label>
            <input type="text" name="slug" value="{{ doc.slug if doc else '' }}" placeholder="Генерируется автоматически">
        </div>
        
        <div class="form-group">
            <label>Краткое описание</label>
            <textarea name="description" rows="2" placeholder="Отображается в списке документов">{{ doc.description if doc else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label>Тип документа *</label>
            <select name="document_type_id" required>
                <option value="">Выберите тип</option>
                {% for dt in document_types %}
                <option value="{{ dt.id }}" 
                    {% if doc and doc.document_type_id == dt.id %}selected
                    {% elif preselect_type_id == dt.id %}selected{% endif %}
                    data-has-own-page="{{ 'true' if dt.has_own_page else 'false' }}">
                    {{ dt.name }}{% if dt.has_own_page %} (со своей страницей){% endif %}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label>Порядок сортировки</label>
            <input type="number" name="sort_order" value="{{ doc.sort_order if doc else 0 }}">
        </div>
        
        <div class="form-group">
            <label>{% if doc %}Заменить файл{% else %}Файл *{% endif %}</label>
            <input type="file" name="file" {% if not doc %}required{% endif %}>
            {% if doc %}
            <small style="color:#666;">Текущий файл: <a href="{{ doc.file_path }}" target="_blank">{{ doc.file_path.split('/')[-1] }}</a></small>
            {% endif %}
        </div>
        
        {% if doc %}
        <div class="document-tools">
            <h4>Инструменты для файла</h4>
            
            <div class="tool-section">
                <label style="font-weight: 500; margin-bottom: 10px; display: block;">Переименование файла</label>
                <div class="tool-row">
                    <div class="form-group">
                        <input type="text" id="newDocFilename" value="{{ doc.file_path.split('/')[-1].rsplit('.', 1)[0] }}" placeholder="Новое имя файла">
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="renameDocumentFile()">Переименовать</button>
                </div>
                <small style="color:#666;">Расширение файла сохранится автоматически</small>
            </div>
            
            {% if doc.file_path and doc.file_path.lower().endswith('.pdf') %}
            <div class="tool-section" id="pdf-metadata-tool">
                <label style="font-weight: 500; margin-bottom: 10px; display: block;">Метаданные PDF</label>
                <div class="form-group">
                    <label>Заголовок (Title)</label>
                    <input type="text" id="pdfTitle" placeholder="Заголовок документа">
                </div>
                <div class="form-group">
                    <label>Автор (Author)</label>
                    <input type="text" id="pdfAuthor" placeholder="Автор документа">
                </div>
                <div class="form-group">
                    <label>Тема (Subject)</label>
                    <input type="text" id="pdfSubject" placeholder="Тема документа">
                </div>
                <div class="form-group">
                    <label>Ключевые слова (Keywords)</label>
                    <input type="text" id="pdfKeywords" placeholder="ключевое слово 1, ключевое слово 2">
                </div>
                <button type="button" class="btn btn-primary" onclick="savePdfMetadata()">Сохранить метаданные PDF</button>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        <div id="seo-fields" style="{% if not doc or not doc.document_type or not doc.document_type.has_own_page %}display:none;{% endif %} margin-top: 30px; padding-top: 20px; border-top: 2px solid #ddd;">
            <h3 style="margin-bottom: 20px;">SEO-настройки страницы документа</h3>
            
            <div class="form-group">
                <label>Превью изображение (первая страница документа)</label>
                <div id="preview-section-wrapper" style="{% if not doc or not doc.preview_image %}display:none;{% endif %}">
                    <div class="preview-edit-section">
                        <div class="preview-image-container">
                            <img src="{{ doc.preview_image if doc else '' }}" id="previewImageEl">
                            <div style="margin-top: 10px;">
                                <span class="info-badge" id="previewDimensions"></span>
                                <span class="info-badge" id="previewFileSize"></span>
                                <span class="info-badge" id="previewFormat"></span>
                            </div>
                        </div>
                        <div class="preview-seo-fields">
                            <div class="form-group">
                                <label>Alt текст (для SEO)</label>
                                <input type="text" id="previewAltText" value="{{ doc.preview_alt_text or '' if doc else '' }}" placeholder="Описание изображения для поисковиков">
                            </div>
                            <div class="form-group">
                                <label>Title (при наведении)</label>
                                <input type="text" id="previewTitleText" value="{{ doc.preview_title_text or '' if doc else '' }}" placeholder="Текст при наведении курсора">
                            </div>
                            <div class="form-group">
                                <label>Подпись (caption)</label>
                                <input type="text" id="previewCaption" value="{{ doc.preview_caption or '' if doc else '' }}" placeholder="Подпись к изображению">
                            </div>
                            <button type="button" class="btn btn-primary btn-sm" onclick="savePreviewSeo()">Сохранить SEO превью</button>
                            
                            <hr style="margin: 15px 0;">
                            <label style="font-weight: 500;">Переименование файла превью</label>
                            <div class="tool-row" style="margin-top: 10px;">
                                <div class="form-group">
                                    <input type="text" id="newPreviewFilename" value="{{ doc.preview_image.split('/')[-1].rsplit('.', 1)[0] if doc and doc.preview_image else '' }}" placeholder="Новое имя файла">
                                </div>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="renamePreviewImage()">Переименовать</button>
                            </div>
                            
                            <hr style="margin: 15px 0;">
                            <label style="font-weight: 500;">Оптимизация изображения</label>
                            <div class="optimize-row" style="margin-top: 10px;">
                                <div class="form-group">
                                    <label>Качество (%)</label>
                                    <input type="number" id="previewQuality" value="85" min="10" max="100">
                                </div>
                                <div class="form-group">
                                    <label>Макс. ширина</label>
                                    <input type="number" id="previewMaxWidth" value="1200" min="100">
                                </div>
                                <div class="form-group">
                                    <label>Макс. высота</label>
                                    <input type="number" id="previewMaxHeight" value="1200" min="100">
                                </div>
                            </div>
                            <div style="margin-top: 10px;">
                                <label><input type="checkbox" id="previewConvertWebp"> Конвертировать в WebP</label>
                                <button type="button" class="btn btn-warning btn-sm" style="margin-left: 15px;" onclick="optimizePreviewImage()">Оптимизировать</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <input type="file" name="preview_image" accept="image/*">
                    <small style="color:#666;">{% if doc and doc.preview_image %}Загрузить новое превью{% else %}Рекомендуется: скриншот первой страницы документа{% endif %}</small>
                </div>
            </div>
            
            <div class="form-group">
                <label>SEO Title</label>
                <input type="text" name="seo_title" value="{{ doc.seo_title if doc else '' }}" placeholder="Пример: Изопрофлекс 95 — техническое описание | Документация">
            </div>
            
            <div class="form-group">
                <label>H1</label>
                <input type="text" name="h1" value="{{ doc.h1 if doc else '' }}" placeholder="Пример: Изопрофлекс 95 — техническое описание">
            </div>
            
            <div class="form-group">
                <label>SEO Description</label>
                <textarea name="seo_description" rows="3" placeholder="Пример: Техническое описание труб Изопрофлекс 95 (0,6 МПа): типоразмеры, конструкция...">{{ doc.seo_description if doc else '' }}</textarea>
            </div>
            
            <div class="form-group">
                <label>SEO-текст страницы (содержит ссылку на скачивание и связанные разделы)</label>
                <textarea name="seo_text_html" id="seo_text_html" class="form-control" rows="10">{{ doc.seo_text_html if doc else '' }}</textarea>
                <small style="color:#666;">Текст сохраняется как есть. Вы можете использовать HTML-теги для форматирования.</small>
            </div>
        </div>
        
        <div style="margin-top: 20px;">
            <button type="submit" class="btn btn-primary">{% if doc %}Сохранить{% else %}Загрузить{% endif %}</button>
            <a href="{{ url_for('admin.documents_list') }}" class="btn btn-secondary">Отмена</a>
        </div>
    </form>
</div>

<script>
document.querySelector('select[name="document_type_id"]').addEventListener('change', function() {
    var selected = this.options[this.selectedIndex];
    var hasOwnPage = selected.getAttribute('data-has-own-page') === 'true';
    document.getElementById('seo-fields').style.display = hasOwnPage ? 'block' : 'none';
});

{% if doc %}
const docId = {{ doc.id }};
const csrfToken = document.querySelector('input[name="csrf_token"]').value;

// Initial load of info if image exists
if (document.getElementById('preview-section-wrapper') && document.getElementById('preview-section-wrapper').style.display !== 'none') {
    fetch(`/admin/api/document/${docId}/info/`)
        .then(response => response.json())
        .then(data => {
            if (data.preview_info) {
                document.getElementById('previewDimensions').textContent = data.preview_info.dimensions;
                document.getElementById('previewFileSize').textContent = data.preview_info.file_size_str;
                document.getElementById('previewFormat').textContent = data.preview_info.format;
                document.getElementById('previewMaxWidth').value = data.preview_info.width || 1200;
                document.getElementById('previewMaxHeight').value = data.preview_info.height || 1200;
            }
        });
}

function renameDocumentFile() {
    const newName = document.getElementById('newDocFilename').value.trim();
    if (!newName) {
        alert('Введите новое имя файла');
        return;
    }
    
    fetch(`/admin/api/document/${docId}/rename/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ new_name: newName })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Файл переименован');
            location.reload();
        } else {
            alert('Ошибка: ' + result.error);
        }
    })
    .catch(err => alert('Ошибка переименования'));
}

// PDF metadata functions
if (document.getElementById('pdf-metadata-tool')) {
    fetch(`/admin/api/document/${docId}/pdf-metadata/`)
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                document.getElementById('pdfTitle').value = data.title || '';
                document.getElementById('pdfAuthor').value = data.author || '';
                document.getElementById('pdfSubject').value = data.subject || '';
                document.getElementById('pdfKeywords').value = data.keywords || '';
            }
        });
}

function savePdfMetadata() {
    const data = {
        title: document.getElementById('pdfTitle').value,
        author: document.getElementById('pdfAuthor').value,
        subject: document.getElementById('pdfSubject').value,
        keywords: document.getElementById('pdfKeywords').value
    };
    
    fetch(`/admin/api/document/${docId}/pdf-metadata/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Метаданные PDF сохранены');
        } else {
            alert('Ошибка: ' + result.error);
        }
    })
    .catch(err => alert('Ошибка сохранения'));
}

function renamePreviewImage() {
    const newName = document.getElementById('newPreviewFilename').value.trim();
    if (!newName) {
        alert('Введите новое имя файла');
        return;
    }
    
    fetch(`/admin/api/document/${docId}/preview/rename/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({ new_name: newName })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Файл превью переименован');
            location.reload();
        } else {
            alert('Ошибка: ' + result.error);
        }
    })
    .catch(err => alert('Ошибка переименования'));
}

function optimizePreviewImage() {
    const data = {
        quality: parseInt(document.getElementById('previewQuality').value) || 85,
        max_width: parseInt(document.getElementById('previewMaxWidth').value) || 1200,
        max_height: parseInt(document.getElementById('previewMaxHeight').value) || 1200,
        convert_to_webp: document.getElementById('previewConvertWebp').checked
    };
    
    fetch(`/admin/api/document/${docId}/preview/optimize/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            document.getElementById('previewImageEl').src = result.new_path + '?t=' + Date.now();
            if (result.info) {
                document.getElementById('previewDimensions').textContent = result.info.dimensions;
                document.getElementById('previewFileSize').textContent = result.info.file_size_str;
                document.getElementById('previewFormat').textContent = result.info.format;
            }
            alert('Изображение оптимизировано');
        } else {
            alert('Ошибка: ' + result.error);
        }
    })
    .catch(err => alert('Ошибка оптимизации'));
}
{% endif %}
{% endif %}
</script>
{% endblock %}

{% block scripts %}
{% endblock %}
