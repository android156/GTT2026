{% extends 'admin/base.html' %}
{% from 'admin/_wysiwyg.html' import wysiwyg_editor, wysiwyg_styles, wysiwyg_scripts %}
{% block content %}
<div class="admin-header">
    <h1>{{ 'Редактировать услугу' if service else 'Добавить услугу' }}</h1>
    <a href="{{ url_for('admin.services_list') }}" class="btn btn-secondary">Назад к списку</a>
</div>
<form method="POST" enctype="multipart/form-data" class="admin-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <div class="form-group">
        <label>Заголовок услуги</label>
        <input type="text" name="title" value="{{ service.title if service else '' }}" required class="form-control">
        <small class="form-text text-muted">Например: Доставка труб</small>
    </div>
    <div class="form-group">
        <label>URL Slug</label>
        <input type="text" name="slug" value="{{ service.slug if service else '' }}" class="form-control">
        <small class="form-text text-muted">Если оставить пустым, сгенерируется из заголовка. Например: dostavka</small>
    </div>
    <div class="form-group">
        <label>Контент (HTML)</label>
        {{ wysiwyg_editor('content_html', 'content_html', service.content_html if service else '') }}
    </div>
    <hr>
    <h3>Галерея изображений</h3>
    <p class="section-desc">Загрузите изображения для галереи. Выберите главное изображение, которое будет отображаться в списке услуг.</p>
    
    {% if service and service.images.count() > 0 %}
    <div class="gallery-manager">
        <div class="gallery-images">
            {% for img in service.images.order_by('sort_order').all() %}
            <div class="gallery-item {% if img.is_main %}is-main{% endif %}" data-id="{{ img.id }}">
                <div class="gallery-img-wrap">
                    <img src="{{ img.image_path }}" alt="" style="transform: rotate({{ img.rotation or 0 }}deg);">
                </div>
                <div class="gallery-rotate">
                    <button type="button" class="btn-rotate" onclick="rotateImage({{ img.id }}, -90)" title="Повернуть влево">↺</button>
                    <span class="rotation-deg">{{ img.rotation or 0 }}°</span>
                    <button type="button" class="btn-rotate" onclick="rotateImage({{ img.id }}, 90)" title="Повернуть вправо">↻</button>
                </div>
                <div class="gallery-controls">
                    <button type="button" class="btn-edit-image" onclick="openImageEditModal({{ img.id }}, 'service')">SEO / Оптимизация</button>
                    <label title="Главное изображение">
                        <input type="radio" name="main_image_id" value="{{ img.id }}" {% if img.is_main %}checked{% endif %}> Главное
                    </label>
                    <label title="Без водяного знака" class="watermark-toggle">
                        <input type="checkbox" onchange="toggleWatermark({{ img.id }}, 'service', this.checked)" {% if img.no_watermark %}checked{% endif %}> Без водяного знака
                    </label>
                    <label title="Удалить">
                        <input type="checkbox" name="delete_images[]" value="{{ img.id }}"> Удалить
                    </label>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <div class="form-group">
        <label>Добавить изображения в галерею</label>
        <input type="file" name="gallery_images" multiple accept="image/*" class="form-control">
        <small class="form-text text-muted">Можно выбрать несколько файлов</small>
    </div>
    
    <div class="form-group">
        <label>Интервал прокрутки галереи (сек)</label>
        <input type="number" name="gallery_interval" value="{{ service.gallery_interval if service else 5 }}" min="1" max="60" class="form-control" style="width: 100px;">
        <small class="form-text text-muted">Скорость автоматической прокрутки галереи на странице услуги</small>
    </div>
    
    <hr>
    <h3>Hero-изображение</h3>
    <p class="section-desc">Фоновое изображение в шапке страницы услуги</p>
    <div class="form-group">
        <label>URL Hero-изображения</label>
        <input type="text" name="hero_image" value="{{ service.hero_image if service else '' }}" class="form-control" placeholder="/static/images/hero.jpg">
        <small class="form-text text-muted">Путь к изображению или внешний URL (если пусто - используется главное изображение из галереи)</small>
    </div>
    <div class="form-group">
        <label>Заголовок в Hero</label>
        <input type="text" name="hero_title" value="{{ service.hero_title if service else '' }}" class="form-control">
        <small class="form-text text-muted">Крупный текст поверх изображения</small>
    </div>
    <div class="form-group">
        <label>Подзаголовок в Hero</label>
        <input type="text" name="hero_subtitle" value="{{ service.hero_subtitle if service else '' }}" class="form-control">
        <small class="form-text text-muted">Дополнительный текст</small>
    </div>
    <hr>
    <h3>SEO настройки</h3>
    <div class="form-group">
        <label>H1 заголовок</label>
        <input type="text" name="h1" value="{{ service.h1 if service else '' }}" class="form-control">
    </div>
    <div class="form-group">
        <label>SEO Title</label>
        <input type="text" name="seo_title" value="{{ service.seo_title if service else '' }}" class="form-control">
    </div>
    <div class="form-group">
        <label>SEO Description</label>
        <textarea name="seo_description" class="form-control">{{ service.seo_description if service else '' }}</textarea>
    </div>
    <div class="form-group">
        <label>SEO Текст (внизу страницы)</label>
        {{ wysiwyg_editor('seo_text_html', 'seo_text_html', service.seo_text_html if service else '') }}
    </div>
    <hr>
    <div class="form-group">
        <label>Порядок сортировки</label>
        <input type="number" name="sort_order" value="{{ service.sort_order if service else 0 }}" class="form-control">
    </div>
    <div class="form-group">
        <label><input type="checkbox" name="is_active" {{ 'checked' if not service or service.is_active }}> Активна</label>
    </div>
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Сохранить</button>
    </div>
</form>

{{ wysiwyg_styles() }}
{{ wysiwyg_scripts() }}

<style>
.gallery-manager { margin-bottom: 20px; }
.gallery-images { display: flex; flex-wrap: wrap; gap: 15px; }
.gallery-item { 
    border: 2px solid #ddd; 
    border-radius: 8px; 
    padding: 10px; 
    background: #f9f9f9;
    width: 180px;
}
.gallery-item.is-main { border-color: #28a745; background: #e8f5e9; }
.gallery-img-wrap { 
    width: 100%; 
    height: 120px; 
    overflow: hidden; 
    border-radius: 4px; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    background: #eee;
}
.gallery-item img { 
    max-width: 100%; 
    max-height: 120px; 
    object-fit: contain;
    transition: transform 0.3s;
}
.gallery-rotate {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 8px;
    padding: 5px;
    background: #e9ecef;
    border-radius: 4px;
}
.btn-rotate {
    width: 28px;
    height: 28px;
    border: none;
    background: #fff;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.btn-rotate:hover { background: #dee2e6; }
.rotation-deg { font-size: 11px; color: #666; min-width: 30px; text-align: center; }
.gallery-controls { margin-top: 8px; font-size: 12px; }
.gallery-controls label { display: block; margin: 5px 0; cursor: pointer; }
.btn-edit-image {
    padding: 4px 8px;
    font-size: 11px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    margin-bottom: 5px;
    width: 100%;
}
.btn-edit-image:hover { background: #0056b3; }
</style>

<script>
function rotateImage(imageId, degrees) {
    fetch(`{{ url_for('admin.rotate_service_image', image_id=0) }}`.replace('0', imageId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ degrees: degrees })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const item = document.querySelector(`.gallery-item[data-id="${imageId}"]`);
            const img = item.querySelector('img');
            const degSpan = item.querySelector('.rotation-deg');
            img.style.transform = `rotate(${data.rotation}deg)`;
            degSpan.textContent = data.rotation + '°';
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(err => alert('Ошибка сети'));
}
</script>

{% include 'admin/includes/image_edit_modal.html' %}
{% endblock %}
