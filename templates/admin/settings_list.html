{% extends 'admin/base.html' %}
{% block title %}Настройки{% endblock %}
{% block page_title %}Настройки{% endblock %}

{% block content %}
<div class="card">
    <form method="POST" action="{{ url_for('admin.settings_save') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <h3>Telegram</h3>
        <div class="form-group">
            <label>TELEGRAM_TOKEN</label>
            <input type="text" name="setting_TELEGRAM_TOKEN" value="{% for s in settings %}{% if s.key == 'TELEGRAM_TOKEN' %}{{ s.value }}{% endif %}{% endfor %}">
        </div>
        <div class="form-group">
            <label>TELEGRAM_CHAT_ID</label>
            <input type="text" name="setting_TELEGRAM_CHAT_ID" value="{% for s in settings %}{% if s.key == 'TELEGRAM_CHAT_ID' %}{{ s.value }}{% endif %}{% endfor %}">
        </div>
        
        <h3>Контакты</h3>
        <div class="form-group">
            <label>Телефон</label>
            <input type="text" name="setting_PHONE" value="{% for s in settings %}{% if s.key == 'PHONE' %}{{ s.value }}{% endif %}{% endfor %}">
        </div>
        <div class="form-group">
            <label>Email</label>
            <input type="text" name="setting_EMAIL" value="{% for s in settings %}{% if s.key == 'EMAIL' %}{{ s.value }}{% endif %}{% endfor %}">
        </div>
        <div class="form-group">
            <label>Адрес</label>
            <input type="text" name="setting_ADDRESS" value="{% for s in settings %}{% if s.key == 'ADDRESS' %}{{ s.value }}{% endif %}{% endfor %}">
        </div>
        
        <button type="submit" class="btn btn-primary">Сохранить настройки</button>
    </form>
</div>

<div class="card" style="margin-top: 20px;">
    <h3>Водяной знак</h3>
    <p style="color: #666; margin-bottom: 15px;">Водяной знак накладывается поверх изображений в галереях (услуги, линейки, главная). Рекомендуется PNG с прозрачностью.</p>
    
    {% set watermark_setting = settings|selectattr('key', 'equalto', 'WATERMARK_IMAGE')|first %}
    {% set watermark_path = watermark_setting.value if watermark_setting else '' %}
    {% set opacity_setting = settings|selectattr('key', 'equalto', 'WATERMARK_OPACITY')|first %}
    {% set watermark_opacity = (opacity_setting.value|float if opacity_setting else 1.0) %}
    
    {% if watermark_path %}
    <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
        <p><strong>Текущий водяной знак:</strong></p>
        <img src="/{{ watermark_path }}" alt="Водяной знак" style="max-width: 300px; max-height: 100px; border: 1px solid #ddd; background: #fff;">
        <form method="POST" action="{{ url_for('admin.watermark_delete') }}" style="display: inline-block; margin-left: 15px;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Удалить водяной знак?');">Удалить</button>
        </form>
    </div>
    
    <form method="POST" action="{{ url_for('admin.settings_save') }}" style="margin-bottom: 20px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
            <label>Уровень непрозрачности (0.1 - 1.0)</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="range" name="setting_WATERMARK_OPACITY" min="0.1" max="1.0" step="0.1" value="{{ watermark_opacity }}" style="width: 200px;" oninput="this.nextElementSibling.textContent = this.value">
                <span style="min-width: 30px;">{{ watermark_opacity }}</span>
            </div>
            <small style="color: #666;">1.0 = полностью видимый, 0.1 = почти прозрачный</small>
        </div>
        <button type="submit" class="btn btn-secondary btn-sm">Сохранить непрозрачность</button>
    </form>
    {% else %}
    <p style="color: #999; margin-bottom: 15px;"><em>Водяной знак не загружен</em></p>
    {% endif %}
    
    <form method="POST" action="{{ url_for('admin.watermark_upload') }}" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="form-group">
            <label>{% if watermark_path %}Заменить водяной знак{% else %}Загрузить водяной знак{% endif %}</label>
            <input type="file" name="watermark" accept="image/png,image/jpeg,image/webp" required>
        </div>
        <button type="submit" class="btn btn-primary">Загрузить</button>
    </form>
</div>

<div class="card" style="margin-top: 20px;">
    <h3>Резервное копирование</h3>
    <p style="color: #666; margin-bottom: 15px;">Экспорт и импорт всех данных сайта (страницы, категории, линейки, типоразмеры, услуги, новости, настройки и т.д.) в формате JSON.</p>
    
    <div style="display: flex; gap: 30px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 250px;">
            <h4 style="margin-bottom: 10px;">Скачать бэкап</h4>
            <p style="color: #888; font-size: 14px; margin-bottom: 10px;">Скачивает все данные из базы в JSON-файл</p>
            <a href="{{ url_for('admin.backup_download') }}" class="btn btn-primary">
                Скачать бэкап
            </a>
        </div>
        
        <div style="flex: 1; min-width: 250px;">
            <h4 style="margin-bottom: 10px;">Загрузить бэкап</h4>
            <p style="color: #888; font-size: 14px; margin-bottom: 10px;">Восстанавливает данные из JSON-файла</p>
            <form method="POST" action="{{ url_for('admin.backup_upload') }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <input type="file" name="backup_file" accept=".json" required>
                </div>
                <div class="form-group" style="margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" name="clear_existing">
                        <span>Очистить существующие данные перед импортом</span>
                    </label>
                    <small style="color: #cc0000; display: block; margin-top: 5px;">Внимание: при включении этой опции все текущие данные будут удалены!</small>
                </div>
                <button type="submit" class="btn btn-warning" onclick="return confirm('Вы уверены? Это может изменить данные в базе.');">
                    Загрузить бэкап
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
