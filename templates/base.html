<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{{ seo.title if seo else (section.seo_title if section and section.seo_title else site_name) }}{% endblock %}</title>
    <meta name="description" content="{% block description %}{{ seo.description if seo else (section.seo_description if section and section.seo_description else '') }}{% endblock %}">
    {% if canonical %}<link rel="canonical" href="{{ canonical }}">{% endif %}
    {% if og %}
    <meta property="og:title" content="{{ og['og:title'] }}">
    <meta property="og:description" content="{{ og['og:description'] }}">
    <meta property="og:url" content="{{ og['og:url'] }}">
    <meta property="og:type" content="{{ og.get('og:type', 'website') }}">
    <meta property="og:site_name" content="{{ og.get('og:site_name', site_name) }}">
    {% if og.get('og:image') %}<meta property="og:image" content="{{ og['og:image'] }}">{% endif %}
    {% endif %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    {% block extra_head %}{% endblock %}
</head>
<body>
    <header class="header">
        <div class="header-top">
            <div class="container">
                <div class="header-top-inner">
                    <span class="header-phone"><a href="tel:+74995044121">+7 (499) 504-41-21</a></span>
                    <span class="header-email"><a href="mailto:sale@glavtrubtorg.ru">sale@glavtrubtorg.ru</a></span>
                    <span>Пн-Пт: 9:00-18:00</span>
                </div>
            </div>
        </div>
        <div class="header-main">
            <div class="container">
                <div class="header-inner">
                    <a href="/" class="logo">
                        <img src="{{ url_for('static', filename='images/2_1766758792749.png') }}" alt="{{ site_name }}">
                    </a>
                    <nav class="main-nav">
                        <ul class="nav-list">
                            {% for item in menu_items %}
                            <li class="nav-item">
                                <a href="{{ item.url }}" 
                                   {% if item.is_external %}target="_blank"{% endif %}
                                   {% if item.target_blank %}target="_blank"{% endif %}
                                   {% if item.nofollow %}rel="nofollow"{% endif %}>
                                    {{ item.title }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        {% block seo_h1 %}{% endblock %}
        {% block hero %}{% endblock %}
        <div class="container">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                <div class="flash flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}
            
            {% block content %}{% endblock %}
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-about">
                    <div class="footer-logo">
                        <img src="{{ url_for('static', filename='images/2_1766758792749.png') }}" alt="{{ site_name }}">
                    </div>
                    <p class="footer-desc">Поставки гибких предизолированных труб для отопления, горячего и холодного водоснабжения. Работаем с 2010 года.</p>
                </div>
                <div class="footer-nav">
                    <div class="footer-title">Каталог</div>
                    <ul class="footer-links">
                        <li><a href="/izokom/">Трубы ИЗОКОМ</a></li>
                        <li><a href="/izopeks/">Трубы ТВЭЛ-ПЭКС</a></li>
                        <li><a href="/izoprofleks_kasafleks/">Трубы ИЗОПРОФЛЕКС</a></li>
                        <li><a href="/uponor_ecoflex/">Трубы УПОНОР</a></li>
                    </ul>
                </div>
                <div class="footer-nav">
                    <div class="footer-title">Компания</div>
                    <ul class="footer-links">
                        <li><a href="/about/">О компании</a></li>
                        <li><a href="/services/">Услуги</a></li>
                        <li><a href="/documentation/">Документация</a></li>
                        <li><a href="/news/">Новости</a></li>
                    </ul>
                </div>
                <div class="footer-contacts-block">
                    <div class="footer-title">Контакты</div>
                    <div class="footer-contact">
                        <a href="tel:+74995044121">+7 (499) 504-41-21</a><br>
                        <a href="mailto:sale@glavtrubtorg.ru">sale@glavtrubtorg.ru</a><br>
                        127253, Москва, Лианозовский проезд, дом 6
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <div class="footer-copyright">
                    &copy; {{ site_name }}, {{ now().year if now else 2025 }}. Все права защищены.
                </div>
                <div class="footer-legal">
                    <a href="/contacts/">Контакты</a>
                </div>
            </div>
        </div>
    </footer>

    {% block extra_js %}{% endblock %}
    {% if org_jsonld %}
    <script type="application/ld+json">{{ org_jsonld|safe }}</script>
    {% endif %}
    {% if breadcrumbs_jsonld %}
    <script type="application/ld+json">{{ breadcrumbs_jsonld|safe }}</script>
    {% endif %}
    {% if product_jsonld %}
    <script type="application/ld+json">{{ product_jsonld|safe }}</script>
    {% endif %}
    
    <script>
    (function() {
        function getUtmParams() {
            var params = {};
            var search = window.location.search.substring(1);
            if (search) {
                search.split('&').forEach(function(part) {
                    var pair = part.split('=');
                    var key = decodeURIComponent(pair[0]);
                    if (key.indexOf('utm_') === 0) {
                        params[key] = pair[1] ? decodeURIComponent(pair[1]) : '';
                    }
                });
            }
            var stored = sessionStorage.getItem('utm_params');
            if (stored) {
                try {
                    var storedParams = JSON.parse(stored);
                    for (var k in storedParams) {
                        if (!params[k]) params[k] = storedParams[k];
                    }
                } catch(e) {}
            }
            if (Object.keys(params).length > 0) {
                sessionStorage.setItem('utm_params', JSON.stringify(params));
            }
            return params;
        }
        
        function fillUtmFields() {
            var utm = getUtmParams();
            document.querySelectorAll('input[name="utm_source"]').forEach(function(el) { el.value = utm.utm_source || ''; });
            document.querySelectorAll('input[name="utm_medium"]').forEach(function(el) { el.value = utm.utm_medium || ''; });
            document.querySelectorAll('input[name="utm_campaign"]').forEach(function(el) { el.value = utm.utm_campaign || ''; });
            document.querySelectorAll('input[name="utm_term"]').forEach(function(el) { el.value = utm.utm_term || ''; });
            document.querySelectorAll('input[name="utm_content"]').forEach(function(el) { el.value = utm.utm_content || ''; });
        }
        
        function loadCaptcha(questionId, tokenId) {
            var questionEl = document.getElementById(questionId);
            var tokenEl = document.getElementById(tokenId);
            if (!questionEl || !tokenEl) return;
            
            fetch('/get-captcha/')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    questionEl.textContent = 'Решите: ' + data.question + ' = ?';
                    tokenEl.value = data.token;
                })
                .catch(function() {
                    questionEl.textContent = 'Ошибка загрузки капчи';
                });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            fillUtmFields();
            
            if (document.getElementById('cta-captcha-question')) {
                loadCaptcha('cta-captcha-question', 'cta-captcha-token');
            }
            if (document.getElementById('size-captcha-question')) {
                loadCaptcha('size-captcha-question', 'size-captcha-token');
            }
            if (document.getElementById('service-captcha-question')) {
                loadCaptcha('service-captcha-question', 'service-captcha-token');
            }
            if (document.getElementById('contacts-captcha-question')) {
                loadCaptcha('contacts-captcha-question', 'contacts-captcha-token');
            }
        });
    })();
    </script>
</body>
</html>
