{% extends 'admin/base.html' %}
{% block title %}{{ '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' if block else '–î–æ–±–∞–≤–∏—Ç—å' }} –±–ª–æ–∫ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö{% endblock %}
{% block page_title %}{{ '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' if block else '–î–æ–±–∞–≤–∏—Ç—å' }} –±–ª–æ–∫ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö{% endblock %}

{% block content %}
<div class="card">
    <p class="section-desc">–õ–∏–Ω–µ–π–∫–∞: <strong>{{ product_line.name }}</strong></p>
    
    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <div class="form-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞ <span class="required">*</span></label>
            <input type="text" name="name" value="{{ block.name if block else '' }}" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –§–∏—Ç–∏–Ω–≥–∏ –∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è">
            <small class="hint">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ H2</small>
        </div>
        
        <div class="form-group">
            <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <div class="wysiwyg-toolbar" data-target="description_html">
                <button type="button" onclick="formatText('description_html', 'bold')" title="–ñ–∏—Ä–Ω—ã–π"><b>B</b></button>
                <button type="button" onclick="formatText('description_html', 'italic')" title="–ö—É—Ä—Å–∏–≤"><i>I</i></button>
                <button type="button" onclick="formatText('description_html', 'underline')" title="–ü–æ–¥—á—ë—Ä–∫–Ω—É—Ç—ã–π"><u>U</u></button>
                <span class="toolbar-sep"></span>
                <button type="button" onclick="insertTag('description_html', 'p')" title="–ê–±–∑–∞—Ü">P</button>
                <button type="button" onclick="insertTag('description_html', 'ul')" title="–°–ø–∏—Å–æ–∫">UL</button>
                <span class="toolbar-sep"></span>
                <button type="button" onclick="insertLink('description_html')" title="–°—Å—ã–ª–∫–∞">üîó</button>
                <button type="button" onclick="toggleHtmlMode('description_html')" title="HTML –∫–æ–¥">&lt;/&gt;</button>
            </div>
            <textarea name="description_html" id="description_html" rows="4" class="wysiwyg-textarea">{{ block.description_html if block else '' }}</textarea>
            <small class="hint">–¢–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ —Ç–∞–±–ª–∏—Ü–µ–π –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö</small>
        </div>
        
        <div class="form-group">
            <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
            {% if block and block.image_path %}
            <div class="current-image">
                <img src="{{ block.image_path }}" alt="" style="max-width: 200px; max-height: 150px;">
                <div class="form-check" style="margin-top: 10px;">
                    <input type="checkbox" name="delete_image" id="delete_image">
                    <label for="delete_image">–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                </div>
            </div>
            {% endif %}
            <input type="file" name="image_file" accept="image/*">
            <small class="hint">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö</small>
        </div>
        
        <div class="form-group">
            <label>–¢–∞–±–ª–∏—Ü–∞ (HTML)</label>
            <div class="wysiwyg-toolbar" data-target="table_html">
                <button type="button" onclick="formatText('table_html', 'bold')" title="–ñ–∏—Ä–Ω—ã–π"><b>B</b></button>
                <button type="button" onclick="formatText('table_html', 'italic')" title="–ö—É—Ä—Å–∏–≤"><i>I</i></button>
                <span class="toolbar-sep"></span>
                <button type="button" onclick="insertTable('table_html')" title="–í—Å—Ç–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É">‚äû –¢–∞–±–ª–∏—Ü–∞</button>
                <button type="button" onclick="toggleHtmlMode('table_html')" title="HTML –∫–æ–¥">&lt;/&gt;</button>
            </div>
            <textarea name="table_html" id="table_html" rows="8" class="wysiwyg-textarea">{{ block.table_html if block else '' }}</textarea>
            <small class="hint">HTML-—Ç–∞–±–ª–∏—Ü–∞ —Å —Ç–∏–ø–æ—Ä–∞–∑–º–µ—Ä–∞–º–∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏—Ö</small>
        </div>
        
        <div class="form-group">
            <label>–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
            <input type="number" name="sort_order" value="{{ block.sort_order if block else 0 }}" placeholder="0">
            <small class="hint">–ú–µ–Ω—å—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –≤—ã—à–µ –≤ —Å–ø–∏—Å–∫–µ</small>
        </div>
        
        <div class="form-group form-check">
            <input type="checkbox" name="is_active" id="is_active" {{ 'checked' if block and block.is_active else 'checked' if not block else '' }}>
            <label for="is_active">–ê–∫—Ç–∏–≤–µ–Ω</label>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <a href="{{ url_for('admin.accessory_blocks_list', pl_id=product_line.id) }}" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
        </div>
    </form>
</div>

<style>
.wysiwyg-toolbar {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin-bottom: 5px;
    padding: 8px;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-bottom: none;
    border-radius: 4px 4px 0 0;
}
.wysiwyg-toolbar button {
    padding: 5px 10px;
    border: 1px solid #ccc;
    background: white;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    min-width: 30px;
}
.wysiwyg-toolbar button:hover { background: #e9e9e9; }
.toolbar-sep {
    width: 1px;
    background: #ccc;
    margin: 0 4px;
    align-self: stretch;
}
.wysiwyg-textarea { 
    border-radius: 0 0 4px 4px !important; 
    font-family: monospace;
}
</style>

<script>
function formatText(textareaId, format) {
    const textarea = document.getElementById(textareaId);
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selected = textarea.value.substring(start, end);
    
    let tag = '';
    switch(format) {
        case 'bold': tag = 'strong'; break;
        case 'italic': tag = 'em'; break;
        case 'underline': tag = 'u'; break;
    }
    
    const replacement = `<${tag}>${selected}</${tag}>`;
    textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
    textarea.focus();
}

function insertTag(textareaId, tag) {
    const textarea = document.getElementById(textareaId);
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selected = textarea.value.substring(start, end);
    
    let replacement;
    if (tag === 'ul') {
        const items = selected ? selected.split('\n').map(line => `  <li>${line}</li>`).join('\n') : '  <li></li>';
        replacement = `<ul>\n${items}\n</ul>`;
    } else {
        replacement = `<${tag}>${selected}</${tag}>`;
    }
    
    textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
    textarea.focus();
}

function insertLink(textareaId) {
    const url = prompt('–í–≤–µ–¥–∏—Ç–µ URL:');
    if (!url) return;
    
    const textarea = document.getElementById(textareaId);
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selected = textarea.value.substring(start, end) || '–¢–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏';
    
    const replacement = `<a href="${url}">${selected}</a>`;
    textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
    textarea.focus();
}

function insertTable(textareaId) {
    const rows = prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫:', '3');
    if (!rows) return;
    const cols = prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤:', '3');
    if (!cols) return;
    
    const numRows = parseInt(rows) || 3;
    const numCols = parseInt(cols) || 3;
    
    let table = '<table class="content-table">\n';
    table += '  <thead>\n    <tr>\n';
    for (let c = 0; c < numCols; c++) {
        table += `      <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫ ${c + 1}</th>\n`;
    }
    table += '    </tr>\n  </thead>\n  <tbody>\n';
    for (let r = 0; r < numRows - 1; r++) {
        table += '    <tr>\n';
        for (let c = 0; c < numCols; c++) {
            table += '      <td></td>\n';
        }
        table += '    </tr>\n';
    }
    table += '  </tbody>\n</table>';
    
    const textarea = document.getElementById(textareaId);
    const pos = textarea.selectionStart;
    textarea.value = textarea.value.substring(0, pos) + table + textarea.value.substring(pos);
    textarea.focus();
}

function toggleHtmlMode(textareaId) {
    const textarea = document.getElementById(textareaId);
    textarea.classList.toggle('html-mode');
}
</script>
{% endblock %}
