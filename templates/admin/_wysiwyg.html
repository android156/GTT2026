{% macro wysiwyg_toolbar(field_id) %}
<div class="wysiwyg-toolbar" data-target="{{ field_id }}">
    <button type="button" onclick="formatText('{{ field_id }}', 'bold')" title="–ñ–∏—Ä–Ω—ã–π"><b>B</b></button>
    <button type="button" onclick="formatText('{{ field_id }}', 'italic')" title="–ö—É—Ä—Å–∏–≤"><i>I</i></button>
    <button type="button" onclick="formatText('{{ field_id }}', 'underline')" title="–ü–æ–¥—á—ë—Ä–∫–Ω—É—Ç—ã–π"><u>U</u></button>
    <span class="toolbar-sep"></span>
    <button type="button" onclick="insertTag('{{ field_id }}', 'h2')" title="–ó–∞–≥–æ–ª–æ–≤–æ–∫ H2">H2</button>
    <button type="button" onclick="insertTag('{{ field_id }}', 'h3')" title="–ó–∞–≥–æ–ª–æ–≤–æ–∫ H3">H3</button>
    <button type="button" onclick="insertTag('{{ field_id }}', 'p')" title="–ê–±–∑–∞—Ü">P</button>
    <button type="button" onclick="insertTag('{{ field_id }}', 'ul')" title="–°–ø–∏—Å–æ–∫">UL</button>
    <span class="toolbar-sep"></span>
    <button type="button" onclick="alignText('{{ field_id }}', 'left')" title="–ü–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é">‚¨±</button>
    <button type="button" onclick="alignText('{{ field_id }}', 'center')" title="–ü–æ —Ü–µ–Ω—Ç—Ä—É">‚¨å</button>
    <button type="button" onclick="alignText('{{ field_id }}', 'right')" title="–ü–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é">‚¨≤</button>
    <button type="button" onclick="alignText('{{ field_id }}', 'justify')" title="–ü–æ —à–∏—Ä–∏–Ω–µ">‚ò∞</button>
    <span class="toolbar-sep"></span>
    <button type="button" onclick="insertLink('{{ field_id }}')" title="–°—Å—ã–ª–∫–∞">üîó</button>
    <button type="button" onclick="insertTable('{{ field_id }}')" title="–¢–∞–±–ª–∏—Ü–∞">‚äû</button>
    <button type="button" onclick="toggleHtmlMode('{{ field_id }}')" title="HTML –∫–æ–¥">&lt;/&gt;</button>
</div>
{% endmacro %}

{% macro wysiwyg_styles() %}
<style>
.wysiwyg-toolbar {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin-bottom: 5px;
    padding: 8px;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-bottom: none;
    border-radius: 4px 4px 0 0;
}
.wysiwyg-toolbar button {
    padding: 5px 10px;
    border: 1px solid #ccc;
    background: white;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    min-width: 30px;
}
.wysiwyg-toolbar button:hover { background: #e9e9e9; }
.toolbar-sep {
    width: 1px;
    background: #ccc;
    margin: 0 4px;
    align-self: stretch;
}
.wysiwyg-textarea { 
    border-radius: 0 0 4px 4px !important; 
    font-family: monospace;
}
.wysiwyg-textarea.html-mode {
    font-family: 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.4;
    background: #f8f8f8;
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è HTML —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
.html-modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 10000;
    justify-content: center;
    align-items: center;
}
.html-modal-overlay.active {
    display: flex;
}
.html-modal {
    background: white;
    width: 90%;
    max-width: 900px;
    max-height: 85vh;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
}
.html-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #ddd;
    background: #f5f5f5;
    border-radius: 8px 8px 0 0;
}
.html-modal-header h3 {
    margin: 0;
    font-size: 16px;
    color: #333;
}
.html-modal-close {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    padding: 0;
    line-height: 1;
}
.html-modal-close:hover {
    color: #d32f2f;
}
.html-modal-body {
    flex: 1;
    padding: 20px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}
.html-modal-textarea {
    width: 100%;
    flex: 1;
    min-height: 400px;
    font-family: 'Courier New', Consolas, monospace;
    font-size: 13px;
    line-height: 1.5;
    padding: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
    resize: none;
    background: #1e1e1e;
    color: #d4d4d4;
}
.html-modal-textarea:focus {
    outline: none;
    border-color: #d32f2f;
}
.html-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 15px 20px;
    border-top: 1px solid #ddd;
    background: #f5f5f5;
    border-radius: 0 0 8px 8px;
}
.html-modal-footer button {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}
.html-modal-save {
    background: #d32f2f;
    color: white;
}
.html-modal-save:hover {
    background: #b71c1c;
}
.html-modal-cancel {
    background: #e0e0e0;
    color: #333;
}
.html-modal-cancel:hover {
    background: #bdbdbd;
}
</style>
{% endmacro %}

{% macro wysiwyg_scripts() %}
<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è HTML -->
<div id="htmlEditorModal" class="html-modal-overlay">
    <div class="html-modal">
        <div class="html-modal-header">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HTML-–∫–æ–¥–∞</h3>
            <button type="button" class="html-modal-close" onclick="closeHtmlModal()">&times;</button>
        </div>
        <div class="html-modal-body">
            <textarea id="htmlModalTextarea" class="html-modal-textarea"></textarea>
        </div>
        <div class="html-modal-footer">
            <button type="button" class="html-modal-cancel" onclick="closeHtmlModal()">–û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="html-modal-save" onclick="saveHtmlModal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
let currentHtmlTargetId = null;

function formatText(textareaId, format) {
    const textarea = document.getElementById(textareaId);
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selected = textarea.value.substring(start, end);
    
    let tag = '';
    switch(format) {
        case 'bold': tag = 'strong'; break;
        case 'italic': tag = 'em'; break;
        case 'underline': tag = 'u'; break;
    }
    
    const replacement = `<${tag}>${selected}</${tag}>`;
    textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
    textarea.focus();
    textarea.setSelectionRange(start + tag.length + 2, start + tag.length + 2 + selected.length);
}

function insertTag(textareaId, tag) {
    const textarea = document.getElementById(textareaId);
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selected = textarea.value.substring(start, end);
    
    let replacement;
    if (tag === 'ul') {
        const items = selected ? selected.split('\n').map(line => `  <li>${line}</li>`).join('\n') : '  <li></li>';
        replacement = `<ul>\n${items}\n</ul>`;
    } else {
        replacement = `<${tag}>${selected}</${tag}>`;
    }
    
    textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
    textarea.focus();
}

function insertLink(textareaId) {
    const url = prompt('–í–≤–µ–¥–∏—Ç–µ URL:');
    if (!url) return;
    
    const textarea = document.getElementById(textareaId);
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selected = textarea.value.substring(start, end) || '–¢–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏';
    
    const replacement = `<a href="${url}">${selected}</a>`;
    textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
    textarea.focus();
}

function alignText(textareaId, alignment) {
    const textarea = document.getElementById(textareaId);
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selected = textarea.value.substring(start, end);
    
    const replacement = `<p style="text-align: ${alignment};">${selected}</p>`;
    textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
    textarea.focus();
}

function insertTable(textareaId) {
    const rows = prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫:', '3');
    if (!rows) return;
    const cols = prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–æ–ª–±—Ü–æ–≤:', '3');
    if (!cols) return;
    
    const numRows = parseInt(rows) || 3;
    const numCols = parseInt(cols) || 3;
    
    let table = '<table class="content-table">\n';
    table += '  <thead>\n    <tr>\n';
    for (let c = 0; c < numCols; c++) {
        table += `      <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫ ${c + 1}</th>\n`;
    }
    table += '    </tr>\n  </thead>\n  <tbody>\n';
    for (let r = 0; r < numRows - 1; r++) {
        table += '    <tr>\n';
        for (let c = 0; c < numCols; c++) {
            table += '      <td></td>\n';
        }
        table += '    </tr>\n';
    }
    table += '  </tbody>\n</table>';
    
    const textarea = document.getElementById(textareaId);
    const pos = textarea.selectionStart;
    textarea.value = textarea.value.substring(0, pos) + table + textarea.value.substring(pos);
    textarea.focus();
}

function toggleHtmlMode(textareaId) {
    currentHtmlTargetId = textareaId;
    const textarea = document.getElementById(textareaId);
    const modal = document.getElementById('htmlEditorModal');
    const modalTextarea = document.getElementById('htmlModalTextarea');
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º HTML –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    let html = textarea.value;
    html = html
        .replace(/></g, '>\n<')
        .replace(/\n\n+/g, '\n')
        .trim();
    
    modalTextarea.value = html;
    modal.classList.add('active');
    modalTextarea.focus();
}

function closeHtmlModal() {
    const modal = document.getElementById('htmlEditorModal');
    modal.classList.remove('active');
    currentHtmlTargetId = null;
}

function saveHtmlModal() {
    if (!currentHtmlTargetId) return;
    
    const textarea = document.getElementById(currentHtmlTargetId);
    const modalTextarea = document.getElementById('htmlModalTextarea');
    
    // –ú–∏–Ω–∏—Ñ–∏—Ü–∏—Ä—É–µ–º HTML –æ–±—Ä–∞—Ç–Ω–æ (—É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å—ã)
    let html = modalTextarea.value
        .replace(/\n\s*/g, '')
        .replace(/>\s+</g, '><')
        .trim();
    
    textarea.value = html;
    closeHtmlModal();
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeHtmlModal();
    }
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞
document.getElementById('htmlEditorModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeHtmlModal();
    }
});
</script>
{% endmacro %}
