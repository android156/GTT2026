{% macro wysiwyg_editor(field_id, field_name, content, rows=10) %}
<div class="wysiwyg-wrapper">
    <div class="wysiwyg-toolbar" data-target="{{ field_id }}">
        <button type="button" onclick="formatText('{{ field_id }}', 'bold')" title="Жирный"><b>B</b></button>
        <button type="button" onclick="formatText('{{ field_id }}', 'italic')" title="Курсив"><i>I</i></button>
        <button type="button" onclick="formatText('{{ field_id }}', 'underline')" title="Подчёркнутый"><u>U</u></button>
        <span class="toolbar-sep"></span>
        <button type="button" onclick="insertTag('{{ field_id }}', 'h2')" title="Заголовок H2">H2</button>
        <button type="button" onclick="insertTag('{{ field_id }}', 'h3')" title="Заголовок H3">H3</button>
        <button type="button" onclick="insertTag('{{ field_id }}', 'p')" title="Абзац">P</button>
        <button type="button" onclick="insertTag('{{ field_id }}', 'ul')" title="Список">UL</button>
        <span class="toolbar-sep"></span>
        <button type="button" onclick="insertLink('{{ field_id }}')" title="Ссылка">Link</button>
        <button type="button" onclick="insertTable('{{ field_id }}')" title="Таблица">Table</button>
        <button type="button" onclick="toggleHtmlMode('{{ field_id }}')" title="HTML код">&lt;/&gt;</button>
    </div>
    <textarea name="{{ field_name }}" id="{{ field_id }}" class="wysiwyg-textarea" rows="{{ rows }}">{{ content }}</textarea>
</div>
{% endmacro %}

{% macro wysiwyg_styles() %}
<style>
.wysiwyg-wrapper {
    margin-bottom: 15px;
}
.wysiwyg-toolbar {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin-bottom: 0;
    padding: 8px;
    background: #f5f5f5;
    border: 1px solid #ccc;
    border-bottom: none;
    border-radius: 4px 4px 0 0;
}
.wysiwyg-toolbar button {
    padding: 6px 12px;
    border: 1px solid #ccc;
    background: white;
    border-radius: 3px;
    cursor: pointer;
    font-size: 13px;
    min-width: 32px;
    transition: background 0.2s;
}
.wysiwyg-toolbar button:hover {
    background: #e9e9e9;
}
.toolbar-sep {
    width: 1px;
    background: #ccc;
    margin: 0 4px;
    align-self: stretch;
}
.wysiwyg-textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ccc;
    border-radius: 0 0 4px 4px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 14px;
    line-height: 1.5;
    resize: vertical;
    min-height: 150px;
}
.wysiwyg-textarea:focus {
    outline: none;
    border-color: #d32f2f;
}
.wysiwyg-textarea.html-mode {
    font-family: 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.4;
    background: #f8f8f8;
}
</style>
{% endmacro %}

{% macro wysiwyg_scripts() %}
<script>
function formatText(textareaId, format) {
    const textarea = document.getElementById(textareaId);
    if (!textarea) return;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selected = textarea.value.substring(start, end);
    
    let tag = '';
    switch(format) {
        case 'bold': tag = 'strong'; break;
        case 'italic': tag = 'em'; break;
        case 'underline': tag = 'u'; break;
    }
    
    const replacement = '<' + tag + '>' + selected + '</' + tag + '>';
    textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
    textarea.focus();
    textarea.setSelectionRange(start + tag.length + 2, start + tag.length + 2 + selected.length);
}

function insertTag(textareaId, tag) {
    const textarea = document.getElementById(textareaId);
    if (!textarea) return;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selected = textarea.value.substring(start, end);
    
    let replacement;
    if (tag === 'ul') {
        const items = selected ? selected.split('\n').map(function(line) { return '  <li>' + line + '</li>'; }).join('\n') : '  <li></li>';
        replacement = '<ul>\n' + items + '\n</ul>';
    } else {
        replacement = '<' + tag + '>' + selected + '</' + tag + '>';
    }
    
    textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
    textarea.focus();
}

function insertLink(textareaId) {
    const url = prompt('Введите URL:');
    if (!url) return;
    
    const textarea = document.getElementById(textareaId);
    if (!textarea) return;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selected = textarea.value.substring(start, end) || 'Текст ссылки';
    
    const replacement = '<a href="' + url + '">' + selected + '</a>';
    textarea.value = textarea.value.substring(0, start) + replacement + textarea.value.substring(end);
    textarea.focus();
}

function insertTable(textareaId) {
    const rows = prompt('Количество строк:', '3');
    if (!rows) return;
    const cols = prompt('Количество столбцов:', '3');
    if (!cols) return;
    
    const numRows = parseInt(rows) || 3;
    const numCols = parseInt(cols) || 3;
    
    let table = '<table>\n  <thead>\n    <tr>\n';
    for (let c = 0; c < numCols; c++) {
        table += '      <th>Заголовок ' + (c + 1) + '</th>\n';
    }
    table += '    </tr>\n  </thead>\n  <tbody>\n';
    for (let r = 0; r < numRows - 1; r++) {
        table += '    <tr>\n';
        for (let c = 0; c < numCols; c++) {
            table += '      <td></td>\n';
        }
        table += '    </tr>\n';
    }
    table += '  </tbody>\n</table>';
    
    const textarea = document.getElementById(textareaId);
    if (!textarea) return;
    const pos = textarea.selectionStart;
    textarea.value = textarea.value.substring(0, pos) + table + textarea.value.substring(pos);
    textarea.focus();
}

function toggleHtmlMode(textareaId) {
    const textarea = document.getElementById(textareaId);
    if (!textarea) return;
    textarea.classList.toggle('html-mode');
    
    if (textarea.classList.contains('html-mode')) {
        const formatted = textarea.value
            .replace(/></g, '>\n<')
            .replace(/\n\n+/g, '\n');
        textarea.value = formatted;
    }
}
</script>
{% endmacro %}

{% macro wysiwyg_toolbar(field_id) %}
<div class="wysiwyg-toolbar" data-target="{{ field_id }}">
    <button type="button" onclick="formatText('{{ field_id }}', 'bold')" title="Жирный"><b>B</b></button>
    <button type="button" onclick="formatText('{{ field_id }}', 'italic')" title="Курсив"><i>I</i></button>
    <button type="button" onclick="formatText('{{ field_id }}', 'underline')" title="Подчёркнутый"><u>U</u></button>
    <span class="toolbar-sep"></span>
    <button type="button" onclick="insertTag('{{ field_id }}', 'h2')" title="Заголовок H2">H2</button>
    <button type="button" onclick="insertTag('{{ field_id }}', 'h3')" title="Заголовок H3">H3</button>
    <button type="button" onclick="insertTag('{{ field_id }}', 'p')" title="Абзац">P</button>
    <button type="button" onclick="insertTag('{{ field_id }}', 'ul')" title="Список">UL</button>
    <span class="toolbar-sep"></span>
    <button type="button" onclick="insertLink('{{ field_id }}')" title="Ссылка">Link</button>
    <button type="button" onclick="insertTable('{{ field_id }}')" title="Таблица">Table</button>
    <button type="button" onclick="toggleHtmlMode('{{ field_id }}')" title="HTML код">&lt;/&gt;</button>
</div>
{% endmacro %}
