{% extends 'admin/base.html' %}
{% from 'admin/_wysiwyg.html' import wysiwyg_editor, wysiwyg_styles, wysiwyg_scripts %}
{% block title %}{{ 'Редактировать' if product_line else 'Добавить' }} линейку{% endblock %}
{% block page_title %}{{ 'Редактировать' if product_line else 'Добавить' }} линейку{% endblock %}

{% block content %}
<div class="card">
    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <h3>Основная информация</h3>
        <div class="form-group">
            <label>Категория <span class="required">*</span></label>
            <select name="category_id" required>
                <option value="">-- Выберите категорию --</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}" {{ 'selected' if product_line and product_line.category_id == cat.id else '' }}>{{ cat.name }}</option>
                {% endfor %}
            </select>
            <small class="hint">К какой категории относится эта линейка товаров</small>
        </div>
        <div class="form-group">
            <label>Название <span class="required">*</span></label>
            <input type="text" name="name" value="{{ product_line.name if product_line else '' }}" required placeholder="Например: ИЗОКОМ-А PE-Xa">
            <small class="hint">Название линейки товаров</small>
        </div>
        <div class="form-group">
            <label>Slug <span class="required">*</span></label>
            <input type="text" name="slug" value="{{ product_line.slug if product_line else '' }}" required pattern="[a-z0-9_-]+" placeholder="Например: izokom-a-pe-xa">
            <small class="hint">Часть URL. Только латиница, цифры, дефис. Пример: сайт.ру/izokom/izokom-a-pe-xa/</small>
        </div>
        
        {% if product_line %}
        <hr>
        <h3>Галерея изображений</h3>
        <p class="section-desc">Загрузите изображения для галереи. Выберите главное изображение для отображения в списке.</p>
        
        {% if product_line.images.count() > 0 %}
        <div class="gallery-manager">
            <div class="gallery-images">
                {% for img in product_line.images.order_by('sort_order').all() %}
                <div class="gallery-item {% if img.is_main %}is-main{% endif %}" data-id="{{ img.id }}">
                    <div class="gallery-img-wrap">
                        <img src="{{ img.image_path }}" alt="" style="transform: rotate({{ img.rotation or 0 }}deg);">
                    </div>
                    <div class="gallery-rotate">
                        <button type="button" class="btn-rotate" onclick="rotateImage({{ img.id }}, -90)" title="Повернуть влево">↺</button>
                        <span class="rotation-deg">{{ img.rotation or 0 }}°</span>
                        <button type="button" class="btn-rotate" onclick="rotateImage({{ img.id }}, 90)" title="Повернуть вправо">↻</button>
                    </div>
                    <div class="gallery-controls">
                        <button type="button" class="btn-edit-image" onclick="openImageEditModal({{ img.id }}, 'product_line')">SEO / Оптимизация</button>
                        <label title="Главное изображение">
                            <input type="radio" name="main_image_id" value="{{ img.id }}" {% if img.is_main %}checked{% endif %}> Главное
                        </label>
                        <label title="Без водяного знака" class="watermark-toggle">
                            <input type="checkbox" onchange="toggleWatermark({{ img.id }}, 'product_line', this.checked)" {% if img.no_watermark %}checked{% endif %}> Без водяного знака
                        </label>
                        <label title="Удалить">
                            <input type="checkbox" name="delete_images[]" value="{{ img.id }}"> Удалить
                        </label>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <div class="form-group">
            <label>Добавить изображения в галерею</label>
            <input type="file" name="gallery_images" multiple accept="image/*">
            <small class="hint">Можно выбрать несколько файлов</small>
        </div>
        
        <div class="form-group">
            <label>Интервал прокрутки галереи (сек)</label>
            <input type="number" name="gallery_interval" value="{{ product_line.gallery_interval if product_line else 5 }}" min="1" max="60" style="width: 100px;">
            <small class="hint">Скорость автоматической прокрутки галереи на странице</small>
        </div>
        {% endif %}
        
        <hr>
        <h3>Ценообразование</h3>
        <p class="section-desc">Настройки скидки и видимости цен для всех типоразмеров этой линейки</p>
        <div class="form-row" style="display: flex; gap: 20px;">
            <div class="form-group" style="flex: 1;">
                <label>Скидка %</label>
                <input type="number" name="discount_percent" value="{{ product_line.discount_percent if product_line else 0 }}" min="0" max="100" step="0.01" style="width: 120px;">
                <small class="hint">Скидка на все типоразмеры линейки (0 = без скидки)</small>
            </div>
            <div class="form-group form-check" style="flex: 1; padding-top: 25px;">
                <input type="checkbox" name="hide_price" id="hide_price" {{ 'checked' if product_line and product_line.hide_price else '' }}>
                <label for="hide_price">Скрыть цены</label>
                <small class="hint">Цена будет видна роботам, пользователям — «по запросу»</small>
            </div>
        </div>
        
        <hr>
        <h3>Hero-изображение</h3>
        <p class="section-desc">Фоновое изображение в шапке страницы линейки</p>
        <div class="form-group">
            <label>URL Hero-изображения</label>
            <input type="text" name="hero_image" value="{{ product_line.hero_image if product_line else '' }}" placeholder="/static/images/hero.jpg">
            <small class="hint">Путь к изображению (если пусто — используется главное из галереи или изображение категории)</small>
        </div>
        <div class="form-group">
            <label>Заголовок в Hero</label>
            <input type="text" name="hero_title" value="{{ product_line.hero_title if product_line else '' }}">
            <small class="hint">Крупный текст поверх изображения (если пусто — название линейки)</small>
        </div>
        <div class="form-group">
            <label>Подзаголовок в Hero</label>
            <input type="text" name="hero_subtitle" value="{{ product_line.hero_subtitle if product_line else '' }}">
            <small class="hint">Дополнительный текст</small>
        </div>
        
        <hr>
        <h3>SEO настройки</h3>
        <div class="form-group">
            <label>H1 заголовок</label>
            <input type="text" name="h1" value="{{ product_line.h1 if product_line else '' }}" placeholder="Например: Труба ИЗОКОМ-А PE-Xa">
            <small class="hint">Главный заголовок страницы (скрытый для SEO)</small>
        </div>
        <div class="form-group">
            <label>SEO Title</label>
            <input type="text" name="seo_title" value="{{ product_line.seo_title if product_line else '' }}" placeholder="Например: ИЗОКОМ-А PE-Xa — купить | ГлавТрубТорг">
            <small class="hint">Заголовок страницы для поисковиков. 50-70 символов</small>
        </div>
        <div class="form-group">
            <label>Краткое описание (seo_description)</label>
            <textarea name="seo_description" rows="2" placeholder="Описание для поисковых систем...">{{ product_line.seo_description if product_line else '' }}</textarea>
            <small class="hint">Отображается в результатах поиска и как описание на странице. 150-160 символов</small>
        </div>
        <div class="form-group">
            <label>SEO текст (внизу страницы)</label>
            {{ wysiwyg_editor('seo_text_html', 'seo_text_html', product_line.seo_text_html if product_line else '') }}
            <small class="hint">Текст внизу страницы для SEO</small>
        </div>
        
        <hr>
        <h3>Настройки</h3>
        <div class="form-group">
            <label>Порядок сортировки</label>
            <input type="number" name="sort_order" value="{{ product_line.sort_order if product_line else 0 }}" placeholder="0">
            <small class="hint">Сортировка по возрастанию. 10, 20, 30...</small>
        </div>
        <div class="form-group form-check">
            <input type="checkbox" name="is_active" id="is_active" {{ 'checked' if product_line and product_line.is_active else 'checked' if not product_line else '' }}>
            <label for="is_active">Активна</label>
            <small class="hint">Неактивные линейки не отображаются на сайте</small>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Сохранить</button>
            <a href="{{ url_for('admin.product_lines_list') }}" class="btn btn-secondary">Отмена</a>
            {% if product_line %}
            <a href="{{ url_for('admin.accessory_blocks_list', pl_id=product_line.id) }}" class="btn btn-info" style="margin-left: auto;">Комплектующие</a>
            {% endif %}
        </div>
    </form>
</div>

{{ wysiwyg_styles() }}
{{ wysiwyg_scripts() }}

<style>
.gallery-manager { margin-bottom: 20px; }
.gallery-images { display: flex; flex-wrap: wrap; gap: 15px; }
.gallery-item { 
    border: 2px solid #ddd; 
    border-radius: 8px; 
    padding: 10px; 
    background: #f9f9f9;
    width: 180px;
}
.gallery-item.is-main { border-color: #28a745; background: #e8f5e9; }
.gallery-img-wrap { 
    width: 100%; 
    height: 120px; 
    overflow: hidden; 
    border-radius: 4px; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    background: #eee;
}
.gallery-item img { 
    max-width: 100%; 
    max-height: 120px; 
    object-fit: contain;
    transition: transform 0.3s;
}
.gallery-rotate {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 8px;
    padding: 5px;
    background: #e9ecef;
    border-radius: 4px;
}
.btn-rotate {
    width: 28px;
    height: 28px;
    border: none;
    background: #fff;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.btn-rotate:hover { background: #dee2e6; }
.rotation-deg { font-size: 11px; color: #666; min-width: 30px; text-align: center; }
.gallery-controls { margin-top: 8px; font-size: 12px; }
.gallery-controls label { display: block; margin: 5px 0; cursor: pointer; }
.btn-edit-image {
    padding: 4px 8px;
    font-size: 11px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    margin-bottom: 5px;
    width: 100%;
}
.btn-edit-image:hover { background: #0056b3; }
.btn-info {
    background: #17a2b8;
    color: white;
}
.btn-info:hover {
    background: #138496;
}
</style>

{% if product_line %}
<script>
function rotateImage(imageId, degrees) {
    fetch(`{{ url_for('admin.rotate_product_line_image', image_id=0) }}`.replace('0', imageId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ degrees: degrees })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const item = document.querySelector(`.gallery-item[data-id="${imageId}"]`);
            const img = item.querySelector('img');
            const degSpan = item.querySelector('.rotation-deg');
            img.style.transform = `rotate(${data.rotation}deg)`;
            degSpan.textContent = data.rotation + '°';
        } else {
            alert('Ошибка: ' + data.error);
        }
    })
    .catch(err => alert('Ошибка сети'));
}
</script>
{% include 'admin/includes/image_edit_modal.html' %}
{% endif %}
{% endblock %}
